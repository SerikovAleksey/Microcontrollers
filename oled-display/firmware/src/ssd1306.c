/**
  ******************************************************************************
  * @file           : ssd1306.c
  * @brief          : SSD1306 driver
  * @author         : MicroTechnics (microtechnics.ru)
  ******************************************************************************
  */



/* Includes ------------------------------------------------------------------*/

#include "ssd1306.h"
#include "ssd1306_interface.h"



/* Declarations and definitions ----------------------------------------------*/

SSD1306_State SSD1306_state = SSD1306_READY;

static uint8_t pixelBuffer[SSD1306_BUFFER_SIZE];



/* Functions -----------------------------------------------------------------*/

/*----------------------------------------------------------------------------*/
void SSD1306_Init()
{   
  uint8_t data[3];
  
  // Set display off
  data[0] = 0xAE;
  SendCommand(data, 1);
  
  // Set oscillator frequency
  data[0] = 0xD5;
  data[1] = 0x80;
  SendCommand(data, 2);
  
  // Enable charge pump regulator
  data[0] = 0x8D;
  data[1] = 0x14;
  SendCommand(data, 2);

  // Set display start line
  data[0] = 0x40;
  SendCommand(data, 1);
  
  // Set segment remap
  data[0] = 0xA1;
  SendCommand(data, 1);
  
  // Set COM output scan direction
  data[0] = 0xC8;
  SendCommand(data, 1);
  
  // Set COM pins hardware configuration
  data[0] = 0xDA;
  data[1] = 0x12;
  SendCommand(data, 2);
  
  // Set MUX ratio
  data[0] = 0xA8;
  data[1] = 63;
  SendCommand(data, 2);
  
  // Set display offset
  data[0] = 0xD3;
  data[1] = 0;
  SendCommand(data, 2);
  
  // Set horizontal addressing mode
  data[0] = 0x20;
  data[1] = 0x00;
  SendCommand(data, 2);
  
  // Set column address
  data[0] = 0x21;
  data[1] = 0;
  data[2] = 127;
  SendCommand(data, 3);
  
  // Set page address
  data[0] = 0x22;
  data[1] = 0;
  data[2] = 7;
  SendCommand(data, 3);
  
  // Set contrast
  data[0] = 0x81;
  data[1] = 0x7F;
  SendCommand(data, 2);

  // Entire display on
  data[0] = 0xA4;
  SendCommand(data, 1);

  //Set normal display
  data[0] = 0xA6;
  SendCommand(data, 1);

  // Set display on
  data[0] = 0xAF;
  SendCommand(data, 1);
}



/*----------------------------------------------------------------------------*/
void SSD1306_UpdateScreen()
{  
  SendData(pixelBuffer, SSD1306_BUFFER_SIZE);
}



/*----------------------------------------------------------------------------*/
void SSD1306_ClearScreen()
{
  for (uint16_t i = 0; i < SSD1306_BUFFER_SIZE; i++)
  {
    pixelBuffer[i] = 0x00;
  }

  SSD1306_UpdateScreen();
}



/*----------------------------------------------------------------------------*/
static void SetPixel(uint8_t x, uint8_t y)
{
  pixelBuffer[x + (y / 8) * SSD1306_X_SIZE] |= (1 << (y % 8));
}



/*----------------------------------------------------------------------------*/
void SSD1306_DrawFilledRect(uint8_t xStart, uint8_t xEnd, uint8_t yStart, uint8_t yEnd)
{
  for (uint8_t i = xStart; i < xEnd; i++)
  {
    for (uint8_t j = yStart; j <  yEnd; j++)
    {
      SetPixel(i, j);
    }
  }
}

const unsigned char bitmap [] = {
0x00, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x00, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x00,
0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0,
0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8,
0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,
0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x3F, 0xFC, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x3F, 0xFE,
0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x3F, 0xFE, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x3F, 0xFE,
0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x3F, 0xFE, 0xFF, 0xE0, 0x3F, 0x84, 0x0F, 0x80, 0x00, 0xFF,
0xFF, 0x80, 0x0F, 0x84, 0x07, 0x80, 0x00, 0xFF, 0xFF, 0x00, 0x07, 0x80, 0x03, 0x80, 0x00, 0xFF,
0xFF, 0x0F, 0x07, 0x81, 0x03, 0x80, 0x00, 0xFF, 0xFF, 0xFF, 0x87, 0x83, 0xC3, 0xFC, 0x3F, 0xFF,
0xFF, 0xFF, 0x87, 0x87, 0xC3, 0xFC, 0x3F, 0xFF, 0xFF, 0xE0, 0x07, 0x87, 0xC3, 0xFC, 0x3F, 0xFF,
0xFF, 0x80, 0x07, 0x87, 0xC3, 0xFC, 0x3F, 0xFF, 0xFF, 0x00, 0x07, 0x87, 0xC3, 0xFC, 0x3F, 0xFF,
0xFE, 0x0F, 0x87, 0x87, 0xC3, 0xFC, 0x3F, 0xFF, 0xFE, 0x1F, 0x87, 0x87, 0xC3, 0xFC, 0x3F, 0xFF,
0xFE, 0x0F, 0x87, 0x87, 0xC3, 0xFC, 0x3F, 0xFF, 0xFE, 0x06, 0x07, 0x87, 0xC3, 0xFC, 0x01, 0xFF,
0xFF, 0x00, 0x07, 0x87, 0xC3, 0xFC, 0x01, 0xFF, 0xFF, 0x00, 0x87, 0x87, 0xC3, 0xFE, 0x01, 0xFF,
0xFF, 0xC1, 0x87, 0x87, 0xC3, 0xFF, 0x81, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFE, 0x01, 0xFF, 0xFF, 0xFF, 0xE3, 0xFF, 0xFF, 0xFE, 0x00, 0xFF, 0xFF, 0xFF, 0xC3, 0xFF, 0xFF,
0xFE, 0x00, 0xFF, 0xFF, 0xFF, 0xC3, 0xFF, 0xFF, 0xFE, 0x00, 0xFF, 0xFF, 0xFF, 0xC3, 0xFF, 0xFF,
0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xC3, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xF8, 0x1F, 0xC3, 0x87, 0xFF,
0xFF, 0xE0, 0xFF, 0xE0, 0x07, 0xC2, 0x03, 0xFF, 0xFF, 0xE0, 0xFF, 0xC0, 0x03, 0xC0, 0x01, 0xFF,
0xFF, 0xE0, 0xFF, 0x81, 0x83, 0xC0, 0x00, 0xFF, 0xFF, 0xE0, 0xFF, 0x87, 0xC1, 0xC1, 0xE0, 0xFF,
0xFF, 0xE0, 0xFF, 0xFF, 0xC1, 0xC1, 0xF0, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xC1, 0xC3, 0xF0, 0xFF,
0xFF, 0xE0, 0xFF, 0xE0, 0x01, 0xC3, 0xF0, 0xFF, 0xFF, 0xE0, 0xFF, 0xC0, 0x01, 0xC3, 0xF0, 0xFF,
0xFF, 0xE0, 0xFF, 0x83, 0xC1, 0xC3, 0xF0, 0xFF, 0xFF, 0xE0, 0xFF, 0x87, 0xC1, 0xC1, 0xF0, 0xFF,
0xFF, 0xF0, 0xFF, 0x07, 0xC1, 0xC1, 0xE0, 0xFF, 0xFF, 0xF0, 0x03, 0x07, 0x81, 0xC0, 0xC0, 0xFF,
0xFF, 0xF0, 0x03, 0x80, 0x01, 0xC0, 0x01, 0xFF, 0x7F, 0xF8, 0x03, 0x80, 0x01, 0xC2, 0x01, 0xFE,
0x7F, 0xFC, 0x03, 0xC0, 0x41, 0xC3, 0x03, 0xFE, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE,
0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,
0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,
0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0,
0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0,
0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x00, 0x00, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x00
};


void SSD1306_DrawPic(int16_t x, int16_t y, int16_t w, int16_t h, uint16_t color)
{
	int16_t byteWidth = (w + 7) / 8; // Bitmap scanline pad = whole byte
	uint8_t byte = 0;

	for (int16_t j = 0; j < h; j++, y++)
	{
		for (int16_t i = 0; i < w; i++)
		{
			if (i & 7)
			{
				byte <<= 1;
			}
			else
			{
				byte = (*(const unsigned char *)(&bitmap[j * byteWidth + i / 8]));
			}
			if (byte & 0x80) SetPixel(x + i, y);
		}
	}
}


/*----------------------------------------------------------------------------*/
uint8_t SSD1306_IsReady()
{
  if (SSD1306_state == SSD1306_BUSY)
  {
    return 0;
  }
  
  return 1;
}



/*----------------------------------------------------------------------------*/
